# Session State Management Specification

## Overview

This document defines the complete end-to-end behavior of session state management in Attention Manager (attn).

## States

| State | Color | Meaning |
|-------|-------|---------|
| `working` | Green (#22c55e) | Claude is actively processing |
| `waiting_input` | Yellow (#eab308) | Claude needs user input |
| `idle` | Gray (#6b7280) | Claude finished, nothing pending |

## Components

```
┌─────────────────┐     ┌──────────────┐     ┌─────────────┐     ┌──────────────┐
│  Claude Code    │────▶│    Hooks     │────▶│   Daemon    │────▶│   Tauri App  │
│  (claude CLI)   │     │  (attn cmds) │     │ (unix sock) │     │  (WebSocket) │
└─────────────────┘     └──────────────┘     └─────────────┘     └──────────────┘
```

### 1. Claude Code
- Fires hooks on specific events
- Provides hook input via stdin (JSON)

### 2. Hooks (generated by attn wrapper)
- `UserPromptSubmit` → sets state to "working"
- `Stop` → triggers classification
- `PostToolUse/TodoWrite` → updates todos

### 3. Daemon
- Listens on `~/.attn.sock` (unix socket)
- Manages session store
- Broadcasts updates via WebSocket (`ws://127.0.0.1:9849/ws`)

### 4. Tauri App
- Connects to daemon WebSocket
- Renders session state in Dashboard, Sidebar, AttentionDrawer

---

## Flow 1: User Submits Prompt → "working"

**Trigger:** User presses Enter in Claude Code

**Steps:**
1. Claude Code fires `UserPromptSubmit` hook
2. Hook executes: `echo '{"cmd":"state","id":"{sessionID}","state":"working"}' | nc -U ~/.attn.sock`
3. Daemon receives `state` command on unix socket
4. Daemon calls `handleState()`:
   - Updates session state in store
   - Broadcasts `session_state_changed` event via WebSocket
5. App receives WebSocket event in `useDaemonSocket`
6. App updates `daemonSessions` store
7. App merges daemon state into local sessions (`enrichedLocalSessions`)
8. Dashboard/Sidebar re-render with green indicator

**Expected Daemon Log:**
```
handleState: session={id}, state=working
```

**Expected WebSocket Event:**
```json
{"event":"session_state_changed","session":{"id":"...","state":"working",...}}
```

---

## Flow 2: Claude Stops → Classification

**Trigger:** Claude finishes generating (stop event)

**Steps:**
1. Claude Code fires `Stop` hook
2. Hook executes: `attn _hook-stop "{sessionID}"` with stdin:
   ```json
   {"session_id":"...","transcript_path":"...","cwd":"...","hook_event_name":"Stop"}
   ```
3. `hook_stop.go` reads stdin, parses JSON
4. `hook_stop.go` sends to daemon: `{"cmd":"stop","id":"{sessionID}","transcript_path":"..."}`
5. Daemon receives `stop` command
6. Daemon calls `handleStop()`:
   - Calls `classifySessionState()` async
7. `classifySessionState()` runs:
   - a. Count pending todos (not starting with `[✓]`)
   - b. If pending > 0 → state = "waiting_input"
   - c. Else parse transcript for last assistant message
   - d. If empty → state = "idle"
   - e. Else call classifier LLM
   - f. Classifier returns "WAITING" → "waiting_input" or "DONE" → "idle"
8. Daemon broadcasts `session_state_changed` event
9. App receives event, updates UI

**Expected Daemon Log:**
```
[hook-stop] called for session: {id}
[hook-stop] raw input: {...}
[hook-stop] parsed: session_id=..., transcript_path=...
handleStop: session={id}, transcript_path=...
classifySessionState: starting for session={id}
classifySessionState: session {id} has N total todos, M pending
classifySessionState: parsing transcript for session {id}
classifier: input text (truncated): ...
classifier: calling claude CLI with 30 second timeout
classifier: claude CLI response: WAITING/DONE
classifySessionState: session {id} classified as waiting_input/idle
```

---

## Flow 3: Todos Updated

**Trigger:** Claude uses TodoWrite tool

**Steps:**
1. Claude Code fires `PostToolUse` hook (matcher: `TodoWrite`)
2. Hook executes: `attn _hook-todo "{sessionID}"` with stdin:
   ```json
   {"tool_input":{"todos":[{"content":"...","status":"pending","activeForm":"..."},...]}}
   ```
3. `runHookTodo()` parses todos, formats with prefixes:
   - `[✓]` = completed
   - `[→]` = in_progress
   - `[ ]` = pending
4. Sends to daemon: `{"cmd":"todos","id":"{sessionID}","todos":[...]}`
5. Daemon updates session todos in store
6. Daemon broadcasts `session_todos_updated` event
7. App receives event, updates UI

---

## Flow 4: Session Registration

**Trigger:** User runs `attn` or `attn -s <label>`

**Steps:**
1. Wrapper generates unique session ID
2. Wrapper ensures daemon is running
3. Wrapper sends: `{"cmd":"register","id":"...","label":"...","cwd":"..."}`
4. Daemon adds session to store (state defaults to "working")
5. Daemon broadcasts `session_registered` event
6. App receives event, adds session to list

---

## Flow 5: Session Unregistration

**Trigger:** Claude Code exits (user runs /exit or Ctrl+C)

**Steps:**
1. Wrapper cleanup function runs
2. Wrapper sends: `{"cmd":"unregister","id":"..."}`
3. Daemon removes session from store
4. Daemon broadcasts `session_unregistered` event
5. App receives event, removes session from list

---

## UI Rendering

### Dashboard (`Dashboard.tsx`)
- Receives `sessions` prop (enrichedLocalSessions from App.tsx)
- Groups by state: `waitingSessions`, `workingSessions`, `idleSessions`
- Renders state dot with CSS class: `.state-dot.working`, `.state-dot.waiting_input`, `.state-dot.idle`

### Sidebar (`Sidebar.tsx`)
- Receives `sessions` prop (enrichedLocalSessions from App.tsx)
- Renders state indicator with CSS class: `.state-indicator.working`, `.state-indicator.waiting_input`, `.state-indicator.idle`

### AttentionDrawer (`AttentionDrawer.tsx`)
- Gets sessions from `useDaemonStore().daemonSessions`
- Filters to only `waiting_input` sessions
- Renders attention items

### Session Enrichment (`App.tsx`)
```typescript
const enrichedLocalSessions = useMemo(() => {
  return sessions.map((local) => {
    const daemon = daemonSessions.find((d) => d.id === local.id);
    return {
      ...local,
      state: daemon?.state ?? 'working', // Default to working if no daemon state
      // ... other fields
    };
  });
}, [sessions, daemonSessions]);
```

**Critical:** Local sessions (with terminals) are enriched with daemon session state. If daemon session doesn't exist, defaults to "working".

---

## Error Cases

| Error | Behavior | Default State |
|-------|----------|---------------|
| Daemon not running | Hook commands fail silently | No state update |
| Unix socket write fails | Error logged, no update | Previous state |
| WebSocket disconnected | UI doesn't receive updates | Previous state |
| Transcript file missing | Parse error logged | `waiting_input` |
| Transcript parse fails | Error logged | `waiting_input` |
| Classifier timeout (30s) | Error logged | `waiting_input` |
| Classifier returns error | Error logged | `waiting_input` |
| Empty last message | N/A | `idle` |

---

## Protocol Messages

### Unix Socket Commands (to daemon)

| Command | Fields | Response |
|---------|--------|----------|
| `register` | id, label, cwd | `{"ok":true}` |
| `unregister` | id | `{"ok":true}` |
| `state` | id, state | `{"ok":true}` |
| `stop` | id, transcript_path | `{"ok":true}` |
| `todos` | id, todos[] | `{"ok":true}` |
| `query` | state (optional) | `{"ok":true,"sessions":[...]}` |

### WebSocket Events (from daemon)

| Event | Fields |
|-------|--------|
| `initial_state` | sessions[], prs[], repos[], protocol_version |
| `session_registered` | session |
| `session_unregistered` | session |
| `session_state_changed` | session |
| `session_todos_updated` | session |
| `sessions_updated` | sessions[] |

---

## Files Involved

| File | Purpose |
|------|---------|
| `internal/hooks/hooks.go` | Generates hook config JSON |
| `cmd/attn/main.go` | Wrapper, runs hooks |
| `cmd/attn/hook_stop.go` | Handles Stop hook |
| `internal/daemon/daemon.go` | handleState, handleStop, classifySessionState |
| `internal/classifier/classifier.go` | LLM classification |
| `internal/transcript/transcript.go` | Parse JSONL transcript |
| `app/src/hooks/useDaemonSocket.ts` | WebSocket client |
| `app/src/store/daemonSessions.ts` | Daemon sessions store |
| `app/src/store/sessions.ts` | Local sessions store |
| `app/src/App.tsx` | Session enrichment |
| `app/src/components/Dashboard.tsx` | Dashboard UI |
| `app/src/components/Sidebar.tsx` | Sidebar UI |
| `app/src/components/AttentionDrawer.tsx` | Attention drawer UI |
